# 大麦完了報告 自動処理システム

## 📋 概要

このシステムは、大麦の完了報告書を自動生成・編集するツールです。
Excel・Word ファイルの自動編集、ファイル管理、出力処理を統一的に行います。

---

## 🚀 使用方法

### 実行方法

```bash
python _main_improved.py
```

### 実行フロー

```
1. 【ステップ0】OUTフォルダの古いファイルをクリーンアップ
   ↓
2. 【ステップ1】証明依頼書を作成
   ├─ 加工完了4を実行 ← 月末ロス計算
   ├─ 加工完了1を実行 ← 産地・輸入許可情報の入力
   ├─ 受払台帳を処理 ← ロス情報取得
   └─ Word文書を編集・保存
   ↓
3. 【ステップ2】ユーザー入力（契約日・取引先番号）
   ↓
4. 【ステップ3】Excelファイルをすべて閉じる
   ↓
5. 【ステップ4】完了報告書を印刷
   ↓
6. 【ステップ5】ファイルをリネーム
   ↓
7. 【ステップ6】電磁記録フォルダを開く
   ↓
8. 【ステップ7】完了報告書をアーカイブにコピー
```

---

## 📥 入力情報

実行中に以下の情報を入力してください：

### 1. 加工完了4実行時
- **月末ロス**: 受払台帳から自動取得（ユーザー入力不要）

### 2. 加工完了1実行時
以下の4項目を順に入力：

| 項目 | 例 | 説明 |
|------|-----|------|
| **産地** | 豪州 | 大麦の産地 |
| **輸入許可番号** | 81177672910 | 輸入許可番号 |
| **輸入許可日** | 2025/10/19 | 輸入許可日（YYYY/MM/DD形式） |
| **船名** | ○○丸 | 輸送船の名前 |

### 3. 証明依頼書編集時
以下の3項目を順に入力：

| 項目 | 例 | 説明 |
|------|-----|------|
| **入庫数量** | 1,050,000 | 入庫した大麦の数量 |
| **加工予定** | 2025/5/22 | 加工予定日（YYYY/M/D形式） |
| **加工数量** | 1,050,000 | 加工予定数量 |

### 4. メイン処理時
以下の2項目を入力：

| 項目 | 例 | 説明 |
|------|-----|------|
| **契約日** | 2025/4/1 | 契約日（YYYY/M/D形式） |
| **取引先番号** | 3 | 1=工業会, 2=全畜連, 3=丸紅, 4=全農, 5=三井物産 |

---

## 📁 ファイル構成

### コアファイル

| ファイル | 用途 |
|---------|------|
| `_main_improved.py` | **メインスクリプト** - 全体処理の統括 |
| `config.py` | 設定ファイル - ファイルパスなどの一元管理 |
| `utils.py` | ユーティリティライブラリ - 共通関数群 |

### 業務処理ファイル

| ファイル | 用途 |
|---------|------|
| `証明依頼書.py` | Word文書の自動生成・編集 |
| `加工完了1.py` | KAKO_HOKOKU1.XLS の編集 |
| `加工完了4.py` | KAKO_HOKOKU4.XLS の編集 |
| `受払台帳.py` | GMG_UKHRI_DAI.xlsx の処理 |

---

## 🔄 ファイル処理フロー

### 入出力フォルダ

```
入力フォルダ:  \\MC10\share\OA\EXCEL\OUT
作業フォルダ:  \\MC10\share\OA\EXCEL\OUT（同じ）
出力フォルダ:  \\MC10\share\農政_電磁記録帳票
```

### ファイルの流れ

```
【テンプレート】
\\MC10\share\農政_電磁記録帳票\丸紅\日清\2021.09.29_契約大麦完了報告書ok\
├─ GMG_UKHRI_DAI.xlsx
├─ KAKO_HOKOKU1.XLS
├─ KAKO_HOKOKU4.XLS
└─ 2021.09.29_3_証明依頼書.docx
   ↓ (コピー)

【OUTフォルダ】
\\MC10\share\OA\EXCEL\OUT\
├─ GMG_UKHRI_DAI.xlsx (編集)
├─ KAKO_HOKOKU1.XLS (編集)
├─ KAKO_HOKOKU4.XLS (編集)
├─ 2021.09.29_3_証明依頼書.docx (編集)
   ↓ (os.rename でリネーム)

【リネーム後】
\\MC10\share\OA\EXCEL\OUT\
├─ 2025.01.20_3_GMG_UKHRI_DAI.xlsx
├─ 2025.01.20_3_KAKO_HOKOKU1.XLS
├─ 2025.01.20_3_KAKO_HOKOKU4.XLS
├─ 2025.01.20_3_証明依頼書.docx
   ↓ (sh.copy でコピー)

【電磁記録フォルダ】
\\MC10\share\農政_電磁記録帳票\
├─ 2025.01.20_3_GMG_UKHRI_DAI.xlsx ✓
├─ 2025.01.20_3_KAKO_HOKOKU1.XLS ✓
├─ 2025.01.20_3_KAKO_HOKOKU4.XLS ✓
└─ 2025.01.20_3_証明依頼書.docx ✓
```

---

## 🛠️ 設定のカスタマイズ

### `config.py` の主要設定

```python
# ファイルパス設定
FILE_PATHS = {
    "gmo_dai": r"\\MC10\share\OA\EXCEL\OUT\GMG_UKHRI_DAI.xlsx",
    "kako_hokoku1": r"\\MC10\share\OA\EXCEL\OUT\KAKO_HOKOKU1.XLS",
    "kako_hokoku4": r"\\MC10\share\OA\EXCEL\OUT\KAKO_HOKOKU4.XLS",
    "shomei": r"\\MC10\share\OA\EXCEL\OUT\2021.09.29_3_証明依頼書.docx",
    "out_folder": r"\\MC10\share\OA\EXCEL\OUT",
    "archive_folder": r"\\MC10\share\農政_電磁記録帳票",
}

# パートナー情報
PARTNERS = {
    1: "工業会",
    2: "全畜連",
    3: "丸紅",
    4: "全農",
    5: "三井物産",
}
```

**変更方法：**
1. `config.py` をテキストエディタで開く
2. 必要な値を修正
3. ファイルを保存

---

## 📊 ロギング出力

実行中は以下のようなログが表示されます：

```
[INFO] 処理を開始します。
[INFO] 【ステップ0】OUTフォルダの古いファイルをクリーンアップしています...
[✓] 削除: 2025.01.10_3_KAKO_HOKOKU1.XLS
[INFO] 【ステップ1】証明依頼書を作成しています...
...
[✓] 報告書の作成を終了しました。
[✓] すべての処理が完了しました。
```

---

## ⚠️ よくあるトラブル

### 1. 「ファイルが見つかりません」エラー

**原因：** OUTフォルダのテンプレートファイルが存在しない

**解決：** 以下のファイルがOUTフォルダに存在するか確認
- `GMG_UKHRI_DAI.xlsx`
- `KAKO_HOKOKU1.XLS`
- `KAKO_HOKOKU4.XLS`
- `2021.09.29_3_証明依頼書.docx`

### 2. Excel が開きっぱなしになる

**原因：** 処理途中でExcel がロックされている

**解決：** 
1. すべてのExcelを手動で閉じる
2. OUTフォルダの古いファイルを削除
3. 再度実行

### 3. 入力情報がWordに反映されない

**原因：** Wordファイルの置き換え対象テキストが見つからない

**解決：** テンプレートファイル（`2021.09.29_3_証明依頼書.docx`）を確認

---

## 🔧 技術情報

### 使用ライブラリ

| ライブラリ | 用途 |
|----------|------|
| `win32com.client` | Excel・Word 自動化 |
| `python-docx` | Word文書操作 |
| `jpholiday` | 祝日判定（営業日計算用） |

### 実行環境

- **Python:** 3.8 以上
- **OS:** Windows
- **必要アプリケーション:** Microsoft Excel, Microsoft Word

---

## 📞 サポート

問題が発生した場合：

1. **ログメッセージを確認** - エラーの詳細情報を確認
2. **`config.py` を確認** - ファイルパスが正しいか再確認
3. **ネットワークドライブの接続を確認** - `\\MC10\share` にアクセス可能か確認
4. **OUTフォルダをクリーンアップ** - 古いファイルを手動削除後、再実行

---

## 📝 更新履歴

**2026年1月20日 - v1.0**
- ✅ 効率化版コード完成
- ✅ ファイルクリーンアップ機能追加
- ✅ ロギング機能統一
- ✅ 説明書作成

---

**作成日:** 2026年1月20日  
**バージョン:** 1.0  
**状態:** ✅ 本運用中
